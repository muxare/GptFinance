<!DOCTYPE html>
<html>
<head>
    <title>Your Website Title</title>
</head>
<body>
    using GptFinance.Application.Interfaces;
using GptFinance.Application.Models;
using GptFinance.Domain.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
namespace YahooFinanceAPI.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class CompaniesController : ControllerBase
    {
        private readonly IYahooSearchService<Company> _yahooSearchService;
        private readonly ICompanyService _companyService;
        public CompaniesController(
            IYahooSearchService<Company> yahooSearchService,
            ICompanyService companyService)
        {
            _yahooSearchService = yahooSearchService;
            _companyService = companyService;
        }
        [HttpGet]
        public async Task<ActionResult<ICollection<Company>>> GetCompanies()
        {
            return Ok(await _companyService.GetAll());
        }
        [HttpGet("{id}")]
        public async Task<ActionResult<Company>> GetCompany(int id)
        {
            var company = await _companyService.FindAsync(id);
            if (company == null)
            {
                return NotFound();
            }
            return company;
        }
        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateCompany(int id, Company company)
        {
            if (id != company.Id)
            {
                return BadRequest();
            }
            await _companyService.UpdateCompany(id, company);
            return NoContent();
        }
        [HttpPost]
        public async Task<ActionResult<Company>> CreateCompany(YahooSearchResult searchResult)
        {
            var company = await _companyService.AddCompanyAsync(searchResult);
            return CreatedAtAction("GetCompany", new { id = company.Id }, company);
        }
        [HttpPost("add-multiple")]
        public async Task<IActionResult> AddMultipleCompaniesAsync([FromBody] List<Company> companies)
        {
            if (companies == null || companies.Count == 0)
            {
                return BadRequest("No companies provided");
            }
            await _companyService.AddMultipleCompaniesAsync(companies);
            return Ok("Companies added successfully");
        }
        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteCompany(int id)
        {
            await _companyService.DeleteCompany(id);
            return NoContent();
        }
        [HttpPost("{id}/fetch")]
        public async Task<ActionResult<Company>> FetchCompanyData(int id)
        {
            var company = await _companyService.FindAsync(id);
            if (company == null)
            {
                return NotFound();
            }
            await _companyService.UpdateCompanyData(company);
            return company;
        }
        [HttpGet("search")]
        public async Task<IActionResult> SearchCompanies(string query)
        {
            if (string.IsNullOrWhiteSpace(query))
            {
                return BadRequest("The query parameter is required.");
            }
            var results = await _yahooSearchService.SearchCompaniesAsync(query);
            return Ok(results);
        }
        [HttpGet("search-multiple")]
        public async Task<IActionResult> SearchCompaniesMultiple(string queries)
        {
            if (string.IsNullOrWhiteSpace(queries))
            {
                return BadRequest("The 'queries' parameter is required.");
            }
            var searchQueries = queries.Split(',').Select(q => q.Trim());
            var results = await _yahooSearchService.SearchCompaniesAsync(searchQueries);
            return Ok(results);
        }
    }
}
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
namespace YahooFinanceAPI.Controllers;
[Route("api/eoddata")]
[ApiController]
public class EodDataController : ControllerBase
{
    private readonly IYahooFinanceService<CsvRecord> _yahooFinanceService;
    private readonly ICompanyService _companyService;
    public EodDataController(IYahooFinanceService<CsvRecord> yahooFinanceService, ICompanyService companyService)
    {
        _yahooFinanceService = yahooFinanceService ?? throw new ArgumentNullException(nameof(yahooFinanceService));
        _companyService = companyService ?? throw new ArgumentNullException(nameof(companyService));
    }
    [HttpGet("{id}")]
    public async Task<ActionResult<ICollection<EodData>>> GetEodData(int id)
    {
        var eodData = await _yahooFinanceService.GetQuotesByCompanyId(id).ConfigureAwait(false);
        if (eodData.Count == 0)
        {
            return NotFound();
        }
        return Ok(eodData);
    }
    [HttpPost("{id}/historical")]
    public async Task<ActionResult<IEnumerable<EodData>>> FetchHistoricalData(int id, DateTime? startDate, DateTime? endDate)
    {
        var company = await _companyService.FindAsync(id);
        if (company == null)
        {
            return NotFound();
        }
        startDate ??= DateTime.MinValue;
        endDate ??= DateTime.UtcNow;
        var _ = await _yahooFinanceService.GetHistoricalDataAsync(company, startDate.Value, endDate.Value);
        return CreatedAtAction(nameof(GetEodData), new { id = company.Id }, null);
    }
}
using GptFinance.Domain.Entities;
using Microsoft.AspNetCore.Mvc;
namespace YahooFinanceAPI.Controllers;
[Route("api/screener")]
[ApiController]
public class ScreenerController : ControllerBase
{
    public ScreenerController()
    {
    }
}
using GptFinance.Application.Interfaces;
using Microsoft.AspNetCore.Mvc;
namespace YahooFinanceAPI.Controllers;
[Route("api/indicators")]
[ApiController]
public class TechnicalIndicatorsController : ControllerBase
{
    private readonly ICompanyService _companyService;
    private readonly ITechnicalIndicatorsService _technicalIndicatorsService;
    private readonly IEodDataRepository _eodDataRepository;
    public TechnicalIndicatorsController(ICompanyService companyService, ITechnicalIndicatorsService technicalIndicatorsService, IEodDataRepository eodDataRepository)
    {
        _companyService = companyService ?? throw new ArgumentNullException(nameof(companyService));
        _technicalIndicatorsService = technicalIndicatorsService ?? throw new ArgumentNullException(nameof(technicalIndicatorsService));
        _eodDataRepository = eodDataRepository ?? throw new ArgumentNullException(nameof(eodDataRepository));
    }
    [HttpPost("{id}/ema")]
    public async Task<IActionResult> CalculateEma(int id, int period)
    {
        var company = await _companyService.FindWithEodDataAsync(id);
        if (company == null)
        {
            return NotFound();
        }
        await _technicalIndicatorsService.CalculateAndStoreEma(id, period, company);
        return NoContent();
    }
    [HttpPost("{id}/macd")]
    public async Task<IActionResult> CalculateMacd(int id, int shortPeriod = 12, int longPeriod = 26, int signalPeriod = 9)
    {
        var company =  await _companyService.FindAsync(id);
        var eodData = await _eodDataRepository.GetQuotesByCompanyId(id);
        company.EodData = eodData;
        await _technicalIndicatorsService.CalculateAndStoreMacd(id, shortPeriod, longPeriod, signalPeriod, company);
        return NoContent();
    }
}
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using System.Text.Json.Serialization;
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using GptFinance.Infrastructure.Models;
using GptFinance.Infrastructure.Repository;
using GptFinance.Infrastructure.Services;
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddResponseCompression(options =>
{
    options.EnableForHttps = true;
});
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddDbContext<AppDbContext>(options =>
        options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
builder.Services.AddTransient<IYahooFinanceService<CsvRecord>, YahooFinanceService>();
builder.Services.AddTransient<IEodDataRepository, EodDataRepository>();
builder.Services.AddTransient<ICompanyRepository, CompanyRepository>();
builder.Services.AddTransient<ITechnicalIndicatorsService, TechnicalIndicatorsService>();
builder.Services.AddTransient<IYahooSearchService<Company>, YahooSearchService>();
builder.Services.AddTransient<IEmaRepository, EmaRepository>();
builder.Services.AddTransient<IMacdRepository, MacdRepository>();
builder.Services.AddTransient<ICompanyService, CompanyService>();
builder.Services.AddSingleton<HttpClient>();
builder.Services.AddControllers().AddJsonOptions(options => options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.Preserve);
var app = builder.Build();
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}
app.UseResponseCompression();
app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();
app.Run();
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface ICompanyRepository : IRepository<Company>
{
    Task<Company?> FindWithEodDataAsync(int id);
}
using System.Linq.Expressions;
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface ICompanyScreenerService
{
    Task<ICollection<Company>> ScreenAsync();
}
using GptFinance.Application.Models;
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface ICompanyService
{
    Task<ICollection<Company>> GetAll();
    Task<Company> FindAsync(int id);
    Task<Company?> FindWithEodDataAsync(int id);
    Task<Company> AddCompanyAsync(YahooSearchResult searchResult);
    Task AddMultipleCompaniesAsync(List<Company> companies);
    Task UpdateCompany(int id, Company company);
    Task UpdateCompanyData(Company company);
    Task DeleteCompany(int id);
}
using System.Linq.Expressions;
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface IEmaRepository
{
    Task<EmaData> GetByCompanyIdAndDateAsync(int companyId, DateTime date);
    Task<List<EmaData>> GetByCompanyIdAsync(int companyId);
    Task<EmaData> AddAsync(EmaData entity);
    Task AddRangeAsync(IEnumerable<EmaData> entities);
    Task<bool> ExistsAsync(int companyId, DateTime date);
    Task<List<EmaData>> GetAsync(Expression<Func<EmaData, bool>> filter);
}
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface IEodDataRepository : IRepository<EodData>
{
    Task<ICollection<EodData>> GetQuotesByCompanyId(int id);
}
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface IMacdRepository
{
    Task<MacdData> GetByCompanyIdAndDateAsync(int companyId, DateTime date);
    Task<List<MacdData>> GetByCompanyIdAsync(int companyId);
    Task<MacdData> AddAsync(MacdData entity);
    Task AddRangeAsync(IEnumerable<MacdData> entities);
    Task<bool> ExistsAsync(int companyId, DateTime date);
}
using System.Linq.Expressions;
namespace GptFinance.Application.Interfaces;
public interface IRepository<T>
{
    Task<T> GetByIdAsync(int id);
    Task<ICollection<T>> GetAllAsync();
    Task<T> AddAsync(T entity);
    Task AddRange(ICollection<T> entities);
    Task UpdateAsync(T entity);
    Task DeleteAsync(int id);
    bool Exists(int id);
}
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface ITechnicalIndicatorsService
{
    decimal CalculateEMA(decimal previousEMA, decimal currentPrice, int period);
    (decimal macdLine, decimal signalLine) CalculateMACD(IEnumerable<decimal> closingPrices, int shortPeriod = 12, int longPeriod = 26, int signalPeriod = 9);
    Task CalculateAndStoreEma(int id, int period, Company company);
    Task CalculateAndStoreMacd(int id, int shortPeriod, int longPeriod, int signalPeriod, Company company);
}
using GptFinance.Domain;
using GptFinance.Domain.Entities;
namespace GptFinance.Application.Interfaces;
public interface IYahooFinanceService<T>
{
    Task<List<EodData>> GetHistoricalDataAsync(Company company, DateTime startDate, DateTime endDate);
    List<EodData> Convert(List<T> csvRecords, int companyId);
    Task<Company?> GetQuoteAsync(string? symbol);
    Task<ICollection<EodData>> GetQuotesByCompanyId(int id);
}
using GptFinance.Application.Models;
namespace GptFinance.Application.Interfaces;
public interface IYahooSearchService<T>
{
    Task<List<YahooSearchResult>?> SearchCompaniesAsync(string query);
    Task<List<T>> SearchCompaniesAsync(IEnumerable<string> queries);
}
using Newtonsoft.Json;
namespace GptFinance.Application.Models;
public record YahooSearchResult
{
    [JsonProperty("symbol")]
    public string? Symbol { get; set; }
    [JsonProperty("shortname")]
    public string? CompanyName { get; set; }
}
using Newtonsoft.Json;
namespace GptFinance.Application.Models;
public class YahooSearchResults
{
    [JsonProperty("quotes")]
    public List<YahooSearchResult>? Quotes { get; set; }
}
namespace GptFinance.Domain.Entities
{
    public class Company
    {
        public int Id { get; set; }
        public string? Symbol { get; set; }
        public string? Name { get; set; }
        public DateTime LastUpdated { get; set; }
        public ICollection<EodData> EodData { get; set; } = new List<EodData>();
    }
}
namespace GptFinance.Domain.Entities
{
    public class EmaData
    {
        public int Id { get; set; }
        public int CompanyId { get; set; }
        public DateTime Date { get; set; }
        public decimal Value { get; set; }
        public int Period { get; set; }
    }
}
using System.Text.Json.Serialization;
namespace GptFinance.Domain.Entities
{
    public class EodData
    {
        public int Id { get; set; }
        public int CompanyId { get; set; }
        public DateTime Date { get; set; }
        public decimal? Open { get; set; }
        public decimal? High { get; set; }
        public decimal? Low { get; set; }
        public decimal? Close { get; set; }
        public long? Volume { get; set; }
    }
}
namespace GptFinance.Domain.Entities
{
    public class MacdData
    {
        public int Id { get; set; }
        public int CompanyId { get; set; }
        public DateTime Date { get; set; }
        public decimal Value { get; set; }
        public int ShortPeriod { get; set; }
        public int LongPeriod { get; set; }
        public int SignalPeriod { get; set; }
    }
}
using CsvHelper;
using CsvHelper.Configuration;
using CsvHelper.TypeConversion;
namespace GptFinance.Infrastructure.Converters
{
    public class NullableDecimalConverter : DecimalConverter
    {
        public override object? ConvertFromString(string? text, IReaderRow row, MemberMapData memberMapData)
        {
            if (string.IsNullOrEmpty(text) || text.Trim().Equals("null", StringComparison.OrdinalIgnoreCase))
            {
                return null;
            }
            return base.ConvertFromString(text, row, memberMapData);
        }
    }
}
using CsvHelper;
using CsvHelper.Configuration;
using CsvHelper.TypeConversion;
namespace GptFinance.Infrastructure.Converters
{
    public class NullableLongConverter : DefaultTypeConverter
    {
        public override object? ConvertFromString(string? text, IReaderRow row, MemberMapData memberMapData)
        {
            if (string.IsNullOrWhiteSpace(text) || text.Equals("null", StringComparison.OrdinalIgnoreCase))
            {
                return null;
            }
            if (long.TryParse(text, NumberStyles.Integer, CultureInfo.InvariantCulture, out long result))
            {
                return result;
            }
            return base.ConvertFromString(text, row, memberMapData);
        }
        public override string? ConvertToString(object? value, IWriterRow row, MemberMapData memberMapData)
        {
            if (value == null)
            {
                return string.Empty;
            }
            return value.ToString();
        }
    }
}
using GptFinance.Domain.Entities;
using Microsoft.EntityFrameworkCore;
namespace GptFinance.Infrastructure.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options)
        {
        }
        public DbSet<Company> Companies { get; set; }
        public DbSet<EodData> EodData { get; set; }
        public DbSet<EmaData> EmaData { get; set; }
        public DbSet<MacdData> MacdData { get; set; }
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            modelBuilder.Entity<EodData>()
                .HasKey(o => new {o.Id, o.CompanyId, o.Date});
            modelBuilder.Entity<EmaData>()
                .HasKey(o => new {o.Id, o.CompanyId, o.Date});
            modelBuilder.Entity<MacdData>()
                .HasKey(o => new {o.Id, o.CompanyId, o.Date});
            base.OnModelCreating(modelBuilder);
        }
    }
}
using CsvHelper.Configuration;
using GptFinance.Infrastructure.Converters;
using GptFinance.Infrastructure.Models;
namespace GptFinance.Infrastructure.Mappings
{
    public sealed class CsvRecordMap : ClassMap<CsvRecord>
    {
        public CsvRecordMap()
        {
            Map(m => m.Date).Name("Date");
            Map(m => m.Open).Name("Open").TypeConverter<NullableDecimalConverter>();
            Map(m => m.High).Name("High").TypeConverter<NullableDecimalConverter>();
            Map(m => m.Low).Name("Low").TypeConverter<NullableDecimalConverter>();
            Map(m => m.Close).Name("Close").TypeConverter<NullableDecimalConverter>();
            Map(m => m.AdjClose).Name("Adj Close").TypeConverter<NullableDecimalConverter>();
            Map(m => m.Volume).Name("Volume").TypeConverter<NullableLongConverter>();
        }
    }
}
namespace GptFinance.Infrastructure.Models;
public class CsvRecord
{
    public DateTime Date { get; set; }
    public decimal? Open { get; set; }
    public decimal? High { get; set; }
    public decimal? Low { get; set; }
    public decimal? Close { get; set; }
    public decimal? AdjClose { get; set; }
    public long? Volume { get; set; }
}
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
namespace GptFinance.Infrastructure.Repository;
public class CompanyRepository : ICompanyRepository
{
    private readonly AppDbContext _context;
    public CompanyRepository(AppDbContext context)
    {
        _context = context;
    }
    public async Task<Company> GetByIdAsync(int id) => await _context.Companies.FindAsync(id);
    public async Task<ICollection<Company>> GetAllAsync() => await _context.Companies.ToListAsync();
    public async Task<Company> AddAsync(Company entity)
    {
        var result = await _context.Companies.AddAsync(entity);
        await _context.SaveChangesAsync();
        return result.Entity;
    }
    public async Task AddRange(ICollection<Company> entities)
    {
        await _context.Companies.AddRangeAsync(entities);
        await _context.SaveChangesAsync();
    }
    public async Task UpdateAsync(Company entity)
    {
        _context.Entry(entity).State = EntityState.Modified;
        await _context.SaveChangesAsync();
    }
    public async Task DeleteAsync(int id)
    {
        var company = await _context.Companies.FindAsync(id);
        if (company != null)
        {
            _context.Companies.Remove(company);
            await _context.SaveChangesAsync();
        }
    }
    public bool Exists(int id)
    {
        return _context.Set<Company>().Any(c => c.Id == id);
    }
    public async Task<Company?> FindWithEodDataAsync(int id)
    {
        return await _context.Companies.Include(c => c.EodData).FirstOrDefaultAsync(c => c.Id == id);
    }
}
using System.Linq.Expressions;
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
namespace GptFinance.Infrastructure.Repository;
public class EmaRepository : IEmaRepository
{
    private readonly AppDbContext _context;
    public EmaRepository(AppDbContext context)
    {
        _context = context;
    }
    public async Task<EmaData> GetByCompanyIdAndDateAsync(int companyId, DateTime date)
    {
        return await _context.EmaData.FirstOrDefaultAsync(e => e.CompanyId == companyId && e.Date == date);
    }
    public async Task<List<EmaData>> GetByCompanyIdAsync(int companyId)
    {
        return await _context.EmaData.Where(e => e.CompanyId == companyId).ToListAsync();
    }
    public async Task<EmaData> AddAsync(EmaData entity)
    {
        _context.EmaData.Add(entity);
        await _context.SaveChangesAsync();
        return entity;
    }
    public async Task AddRangeAsync(IEnumerable<EmaData> entities)
    {
        _context.EmaData.AddRange(entities);
        await _context.SaveChangesAsync();
    }
    public async Task<bool> ExistsAsync(int companyId, DateTime date)
    {
        return await _context.EmaData.AnyAsync(e => e.CompanyId == companyId && e.Date == date);
    }
    public async Task<List<EmaData>> GetAsync(Expression<Func<EmaData, bool>> filter)
    {
        return await _context.EmaData.Where(filter).ToListAsync();
    }
}
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
namespace GptFinance.Infrastructure.Repository;
public class EodDataRepository : IEodDataRepository
{
    private readonly AppDbContext _context;
    public EodDataRepository(AppDbContext context)
    {
        _context = context;
    }
    public async Task<EodData> GetByIdAsync(int id) => await _context.EodData.FindAsync(id);
    public async Task<ICollection<EodData>> GetAllAsync() => await _context.EodData.ToListAsync();
    public async Task<EodData> AddAsync(EodData entity)
    {
        var result = await _context.EodData.AddAsync(entity);
        await _context.SaveChangesAsync();
        return result.Entity;
    }
    public async Task AddRange(ICollection<EodData> entities)
    {
        await _context.EodData.AddRangeAsync(entities);
        await _context.SaveChangesAsync();
    }
    public async Task UpdateAsync(EodData entity)
    {
        _context.Entry(entity).State = EntityState.Modified;
        await _context.SaveChangesAsync();
    }
    public async Task DeleteAsync(int id)
    {
        var eodData = await _context.EodData.FindAsync(id);
        if (eodData != null)
        {
            _context.EodData.Remove(eodData);
            await _context.SaveChangesAsync();
        }
    }
    public bool Exists(int id)
    {
        return _context.Set<EodData>().Any(c => c.Id == id && c.CompanyId == id);
    }
    public async Task<ICollection<EodData>> GetQuotesByCompanyId(int id)
    {
        var eodData = await _context.EodData.Where(e => e.CompanyId == id).OrderByDescending(o => o.Date).ToListAsync();
        return eodData;
    }
}
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
namespace GptFinance.Infrastructure.Repository;
public class MacdRepository : IMacdRepository
{
    private readonly AppDbContext _context;
    public MacdRepository(AppDbContext context)
    {
        _context = context;
    }
    public async Task<MacdData> GetByCompanyIdAndDateAsync(int companyId, DateTime date)
    {
        return await _context.MacdData.FirstOrDefaultAsync(m => m.CompanyId == companyId && m.Date == date);
    }
    public async Task<List<MacdData>> GetByCompanyIdAsync(int companyId)
    {
        return await _context.MacdData.Where(m => m.CompanyId == companyId).ToListAsync();
    }
    public async Task<MacdData> AddAsync(MacdData entity)
    {
        _context.MacdData.Add(entity);
        await _context.SaveChangesAsync();
        return entity;
    }
    public async Task AddRangeAsync(IEnumerable<MacdData> entities)
    {
        _context.MacdData.AddRange(entities);
        await _context.SaveChangesAsync();
    }
    public async Task<bool> ExistsAsync(int companyId, DateTime date)
    {
        return await _context.MacdData.AnyAsync(m => m.CompanyId == companyId && m.Date == date);
    }
}
namespace GptFinance.Infrastructure.Services;
public class CompanyNotFoundException : Exception
{
}
using System.Linq.Expressions;
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
namespace GptFinance.Infrastructure.Services;
public class CompanyScreenerService : ICompanyScreenerService
{
    private readonly ICompanyRepository _companyRepository;
    private readonly IEmaRepository _emaDataRepository;
    private readonly IMacdRepository _macdDataRepository;
    public CompanyScreenerService(IEmaRepository emaDataRepository, IMacdRepository macdDataRepository, ICompanyRepository companyRepository)
    {
        _emaDataRepository = emaDataRepository ?? throw new ArgumentNullException(nameof(emaDataRepository));
        _macdDataRepository = macdDataRepository ?? throw new ArgumentNullException(nameof(macdDataRepository));
        _companyRepository = companyRepository ?? throw new ArgumentNullException(nameof(companyRepository));
    }
    public async Task<ICollection<Company>> ScreenAsync()
    {
        var companies = await _companyRepository.GetAllAsync();
        return companies;
    }
}
using GptFinance.Application.Interfaces;
using GptFinance.Application.Models;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using GptFinance.Infrastructure.Models;
using GptFinance.Infrastructure.Repository;
using Microsoft.EntityFrameworkCore;
namespace GptFinance.Infrastructure.Services
{
    public class CompanyService : ICompanyService
    {
        private readonly IYahooFinanceService<CsvRecord> _yahooFinanceService;
        private readonly ICompanyRepository _companyRepository;
        public CompanyService(AppDbContext context, IYahooFinanceService<CsvRecord> yahooFinanceService, ICompanyRepository companyRepository)
        {
            _yahooFinanceService = yahooFinanceService ?? throw new ArgumentNullException(nameof(yahooFinanceService));
            _companyRepository = companyRepository ?? throw new ArgumentNullException(nameof(companyRepository));
        }
        public async Task<ICollection<Company>> GetAll() => await _companyRepository.GetAllAsync();
        public async Task<Company> AddCompanyAsync(YahooSearchResult searchResult)
        {
            var company = new Company
            {
                Symbol = searchResult.Symbol,
                Name = searchResult.CompanyName,
                LastUpdated = DateTime.UtcNow
            };
            await _companyRepository.AddAsync(company);
            return company;
        }
        public async Task AddMultipleCompaniesAsync(List<Company> companies) => await _companyRepository.AddRange(companies);
        public async Task UpdateCompany(int id, Company company)
        {
            try
            {
                await _companyRepository.UpdateAsync(company);
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!CompanyExists(id))
                {
                    throw new CompanyNotFoundException();
                }
                else
                {
                    throw;
                }
            }
        }
        public async Task UpdateCompanyData(Company company)
        {
            var quote = await _yahooFinanceService.GetQuoteAsync(company.Symbol);
            if (quote == null)
            {
                throw new ArgumentException();
            }
            company.LastUpdated = DateTime.Now;
            await _companyRepository.UpdateAsync(company);
        }
        public async Task DeleteCompany(int id)
        {
            await _companyRepository.DeleteAsync(id);
        }
        private bool CompanyExists(int id) => _companyRepository.Exists(id);
        public async Task<Company> FindAsync(int id) => await _companyRepository.GetByIdAsync(id);
        public async Task<Company?> FindWithEodDataAsync(int id) => await _companyRepository.FindWithEodDataAsync(id);
    }
}
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using Microsoft.EntityFrameworkCore.Metadata;
namespace GptFinance.Infrastructure.Services
{
    public class TechnicalIndicatorsService : ITechnicalIndicatorsService
    {
        private readonly AppDbContext _context;
        public TechnicalIndicatorsService(AppDbContext context)
        {
            _context = context ?? throw new ArgumentNullException(nameof(context));
        }
        public decimal CalculateEMA(decimal previousEma, decimal currentPrice, int period)
        {
            decimal multiplier = 2.0M / (period + 1);
            return (currentPrice - previousEma) * multiplier + previousEma;
        }
        public (decimal macdLine, decimal signalLine) CalculateMACD(IEnumerable<decimal> closingPrices, int shortPeriod = 12, int longPeriod = 26, int signalPeriod = 9)
        {
            var enumerable = closingPrices as decimal[] ?? closingPrices.ToArray();
            var shortEma = enumerable.Take(shortPeriod).Average();
            var longEma = enumerable.Take(longPeriod).Average();
            var macdLine = shortEma - longEma;
            var signalLine = enumerable.Skip(longPeriod).Take(signalPeriod).Average();
            return (macdLine, signalLine);
        }
        public enum ImputationMethod
        {
            Mean,
            Median,
            Mode,
            LastObservationCarriedForward,
            LinearInterpolation
        }
        public Dictionary<DateTime, decimal> ImputeMissingData(Dictionary<DateTime, decimal?> priceData, ImputationMethod method)
        {
            var imputedData = new Dictionary<DateTime, decimal>();
            decimal? lastObservation = null;
            foreach (var dataPoint in priceData)
            {
                if (dataPoint.Value.HasValue)
                {
                    imputedData[dataPoint.Key] = dataPoint.Value.Value;
                    lastObservation = dataPoint.Value.Value;
                }
                else
                {
                    decimal imputedValue = 0;
                    switch (method)
                    {
                        case ImputationMethod.Mean:
                            imputedValue = priceData.Values.Where(v => v.HasValue).Average(v => v.Value);
                            break;
                        case ImputationMethod.Median:
                            imputedValue = Median(priceData.Values.Where(v => v.HasValue).Select(v => v.Value).ToList());
                            break;
                        case ImputationMethod.Mode:
                            imputedValue = priceData.Values.Where(v => v.HasValue).GroupBy(v => v).OrderByDescending(g => g.Count()).First().Key.Value;
                            break;
                        case ImputationMethod.LastObservationCarriedForward:
                            if (lastObservation.HasValue)
                            {
                                imputedValue = lastObservation.Value;
                            }
                            else
                            {
                                throw new InvalidOperationException("Cannot use LastObservationCarriedForward method for the first data point.");
                            }
                            break;
                    }
                    imputedData[dataPoint.Key] = imputedValue;
                }
            }
            return imputedData;
        }
        public decimal Median(List<decimal> values)
        {
            int numberCount = values.Count();
            int halfIndex = values.Count() / 2;
            var sortedNumbers = values.OrderBy(n => n);
            decimal median;
            if ((numberCount % 2) == 0)
            {
                median = ((sortedNumbers.ElementAt(halfIndex - 1) +
                           sortedNumbers.ElementAt(halfIndex)) / 2);
            }
            else
            {
                median = sortedNumbers.ElementAt(halfIndex);
            }
            return median;
        }
        public async Task CalculateAndStoreEma(int id, int period, Company company)
        {
            var closingPrices = company.EodData.OrderBy(e => e.Date).ToDictionary(o => o.Date, o=> o.Close);
            var imputedClosingPrices = ImputeMissingData(closingPrices, ImputationMethod.LastObservationCarriedForward);
            var data = CalculateEMA(imputedClosingPrices, period);
            await _context.SaveChangesAsync();
        }
        private ICollection<EmaData> CalculateEma(int id, int period, Dictionary<DateTime, decimal?> closingPrices)
        {
            var previousEma = (decimal)closingPrices.Take(period)
                .Where(x => x.Value != null)
                .Average(x => x.Value);
            ICollection<EmaData> data = new List<EmaData>();
            foreach (var closingPrice in closingPrices.Skip(period))
            {
                if (closingPrice.Value == null)
                    continue;
                decimal ema = CalculateEMA(previousEma, closingPrice.Value.Value, period);
                data.Add(new EmaData
                    {
                        CompanyId = id,
                        Value = ema,
                        Period = period,
                        Date = closingPrice.Key
                    }
                );
                previousEma = ema;
            }
            return data;
        }
        public async Task CalculateAndStoreMacd(int id, int shortPeriod, int longPeriod, int signalPeriod, Company company)
        {
            var priceData = company.EodData.ToDictionary(o => o.Date, o => (decimal)o.Close);
            var macdData = CalculateMACD(priceData, shortPeriod, longPeriod, signalPeriod);
            var entities = macdData.Select(d => new MacdData
            {
                CompanyId = company.Id,
                Date = d.Key,
                ShortPeriod = shortPeriod,
                LongPeriod = longPeriod,
                SignalPeriod = signalPeriod
            });
            _context.MacdData.AddRange(entities);
            await _context.SaveChangesAsync();
        }
        public Dictionary<DateTime, decimal> CalculateMACD(Dictionary<DateTime, decimal> priceData, int shortPeriod = 12, int longPeriod = 26, int signalPeriod = 9)
        {
            if (priceData.Count < longPeriod)
                throw new ArgumentException("Insufficient data to calculate MACD.");
            var macdLine = new Dictionary<DateTime, decimal>();
            var signalLine = new Dictionary<DateTime, decimal>();
            var histogram = new Dictionary<DateTime, decimal>();
            var shortEma = CalculateEMA(priceData, shortPeriod);
            var longEma = CalculateEMA(priceData, longPeriod);
            foreach (var date in priceData.Keys)
            {
                if (shortEma.ContainsKey(date) && longEma.ContainsKey(date))
                {
                    macdLine[date] = shortEma[date] - longEma[date];
                }
            }
            signalLine = CalculateEMA(macdLine, signalPeriod);
            foreach (var date in macdLine.Keys)
            {
                if (signalLine.ContainsKey(date))
                {
                    histogram[date] = macdLine[date] - signalLine[date];
                }
            }
            return histogram;
        }
        private Dictionary<DateTime, decimal> CalculateEMA(Dictionary<DateTime, decimal> priceData, int period)
        {
            var ema = new Dictionary<DateTime, decimal>();
            decimal multiplier = 2.0M / (period + 1);
            decimal emaPrev = 0;
            for (int i = 0; i < priceData.Count; i++)
            {
                if (i == 0)
                {
                }
                else
                {
                    decimal close = priceData.ElementAt(i).Value;
                }
                ema[priceData.ElementAt(i).Key] = emaPrev;
            }
            return ema;
        }
        private decimal CalculateRSI(IEnumerable<decimal> closingPrices, int period)
        {
            var enumerable = closingPrices as decimal[] ?? closingPrices.ToArray();
            var gains = new List<decimal>();
            var losses = new List<decimal>();
            for (int i = 1; i < enumerable.Count(); i++)
            {
                var difference = enumerable.ElementAt(i) - enumerable.ElementAt(i - 1);
                if (difference > 0)
                    gains.Add(difference);
                else
                    losses.Add(Math.Abs(difference));
            }
            var averageGain = gains.Average();
            var averageLoss = losses.Average();
            var relativeStrength = averageGain / averageLoss;
            var rsi = 100 - (100 / (1 + relativeStrength));
            return rsi;
        }
        private decimal CalculateStochasticOscillator(IEnumerable<decimal> closingPrices, int period)
        {
            var enumerable = closingPrices as decimal[] ?? closingPrices.ToArray();
            var lowest = enumerable.Take(period).Min();
            var highest = enumerable.Take(period).Max();
            var current = enumerable.Last();
            var stochasticOscillator = (current - lowest) / (highest - lowest) * 100;
            return stochasticOscillator;
        }
        private decimal CalculateStochasticRSI(IEnumerable<decimal> closingPrices, int period)
        {
            var enumerable = closingPrices as decimal[] ?? closingPrices.ToArray();
            var lowest = enumerable.Take(period).Min();
            var highest = enumerable.Take(period).Max();
            var current = enumerable.Last();
            var stochasticOscillator = (current - lowest) / (highest - lowest) * 100;
            return stochasticOscillator;
        }
    }
}
using CsvHelper;
using CsvHelper.Configuration;
using GptFinance.Application.Interfaces;
using GptFinance.Domain.Entities;
using GptFinance.Infrastructure.Data;
using GptFinance.Infrastructure.Mappings;
using GptFinance.Infrastructure.Models;
namespace GptFinance.Infrastructure.Services
{
    public class YahooFinanceService : IYahooFinanceService<CsvRecord>
    {
        private readonly IEodDataRepository _eodRepository;
        private readonly HttpClient _httpClient;
        public YahooFinanceService(AppDbContext context, IEodDataRepository eodRepository)
        {
            _eodRepository = eodRepository ?? throw new ArgumentNullException(nameof(eodRepository));
            _httpClient = new HttpClient();
        }
        public async Task<List<EodData>> GetHistoricalDataAsync(Company company, DateTime startDate, DateTime endDate)
        {
            using (var response = await _httpClient.GetAsync(url))
            {
                if (response.IsSuccessStatusCode)
                {
                    var config = new CsvConfiguration(CultureInfo.InvariantCulture)
                    {
                        HeaderValidated = null,
                        MissingFieldFound = null
                    };
                    using (var stream = await response.Content.ReadAsStreamAsync())
                    using (var reader = new StreamReader(stream))
                    using (var csvReader = new CsvReader(reader, config))
                    {
                        csvReader.Context.RegisterClassMap<CsvRecordMap>();
                        var r = csvReader.GetRecords<CsvRecord>();
                        var records = new List<EodData>(Convert(csvReader.GetRecords<CsvRecord>().ToList(), company.Id));
                        await _eodRepository.AddRange(records);
                        return records;
                    }
                }
                else
                {
                    throw new Exception($"Failed to fetch historical data for {company.Symbol}: {response.ReasonPhrase}");
                }
            }
        }
        public List<EodData> Convert(List<CsvRecord> csvRecords, int companyId)
        {
            return csvRecords.Select(r =>
            {
                return new EodData
                {
                    Id = 0,
                    Date = r.Date,
                    Open = r.Open.HasValue ? r.Open.Value : (decimal?)null,
                    High = r.High.HasValue ? r.High.Value : (decimal?)null,
                    Low = r.Low.HasValue ? r.Low.Value : (decimal?)null,
                    Close = r.Close.HasValue ? r.Close.Value : (decimal?)null,
                    Volume = r.Volume.HasValue ? r.Volume.Value : (long?)null,
                    CompanyId = companyId
                };
            }).ToList();
        }
        private static long ToUnixTimestamp(DateTime dateTime)
        {
            var unixEpoch = new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc);
            return (long)(dateTime.ToUniversalTime() - unixEpoch).TotalSeconds;
        }
        public async Task<Company?> GetQuoteAsync(string? symbol)
        {
            var httpClient = new HttpClient();
            var url = $"{BaseUrl}{symbol}?interval=1d&events=history&includeAdjustedClose=true";
            var response = await httpClient.GetAsync(url);
            if (!response.IsSuccessStatusCode)
            {
                return null;
            }
            await using var stream = await response.Content.ReadAsStreamAsync();
            using var streamReader = new StreamReader(stream);
            using var csvReader = new CsvReader(streamReader, CultureInfo.InvariantCulture);
            var quote = csvReader.GetRecords<Company>().FirstOrDefault();
            return quote;
        }
        public async Task<ICollection<EodData>> GetQuotesByCompanyId(int id)
        {
            ICollection<EodData> eodData = await _eodRepository.GetQuotesByCompanyId(id);
            return eodData;
        }
    }
}
using Flurl;
using Flurl.Http;
using GptFinance.Application.Interfaces;
using GptFinance.Application.Models;
using GptFinance.Domain.Entities;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
namespace GptFinance.Infrastructure.Services
{
    public class YahooSearchService : IYahooSearchService<Company>
    {
        private readonly HttpClient _httpClient;
        public YahooSearchService(HttpClient httpClient)
        {
            _httpClient = httpClient;
        }
        public async Task<List<YahooSearchResult>?> SearchCompaniesAsync(string query)
        {
            var response = await $"{YahooFinanceApiBaseUrl}/v1/finance/search"
                .SetQueryParams(new { q = query, quotesCount = 10, newsCount = 0 })
                .GetStringAsync();
            var searchResults = JsonConvert.DeserializeObject<YahooSearchResults>(response);
            return searchResults?.Quotes;
        }
        public async Task<List<Company>> SearchCompaniesAsync(IEnumerable<string> queries)
        {
            var companies = new List<Company>();
            foreach (var query in queries)
            {
                if (response.IsSuccessStatusCode)
                {
                    var jsonResponse = await response.Content.ReadAsStringAsync();
                    var jsonObject = JObject.Parse(jsonResponse);
                    var quoteResults = jsonObject["quotes"] as JArray;
                    if (quoteResults != null)
                    {
                        foreach (var quote in quoteResults)
                        {
                            var symbol = quote["symbol"]?.ToString();
                            var name = quote["shortname"]?.ToString();
                            if (!string.IsNullOrWhiteSpace(symbol) && !string.IsNullOrWhiteSpace(name))
                            {
                                companies.Add(new Company
                                {
                                    Symbol = symbol,
                                    Name = name
                                });
                            }
                        }
                    }
                }
            }
            return companies.GroupBy(c => c.Symbol).Select(g => g.First()).ToList();
        }
    }
}
global using System.Globalization;

</body>
</html>
